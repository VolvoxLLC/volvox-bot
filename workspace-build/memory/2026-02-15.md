# 2026-02-15 — Pip Build Session Notes

## bills-bot Work

### PR #57 — AI Conversation Threading (Issue #23) ✅ MERGED

- Created threading module (`src/modules/threading.js`) — thread creation, reuse within 30 min, scoped history
- Config: `ai.threadMode.{enabled, autoArchiveMinutes, reuseWindowMinutes}`
- Fixed 9 review threads across 2 rounds:
  - Cache eviction with periodic sweep + max-size cap
  - Race condition prevention (per-key lock)
  - Config validation + autoArchive snapping to Discord-allowed values (60/1440/4320/10080)
  - Thread name 100-char clamping for long usernames
  - Channel allowlist fix for thread messages (check parentId)
  - Biome trailing newline fixes
- All merged to main

### PR #59 — User Memory via mem0 (Issue #24) — IN PROGRESS

- Initial implementation: raw HTTP to self-hosted mem0
- **Bill requested rewrite**: use `mem0ai` SDK (v2.2.2), hosted platform (`MEM0_API_KEY`), graph memory enabled
- Rewrote entire module to use SDK with `enable_graph: true` on all operations
- Graph relations formatted as readable context (e.g., "Joseph → works as → software engineer")
- Fixed 12 review threads in Round 1:
  - Auto-recovery for transient failures (60s cooldown instead of permanent disable)
  - Health check uses SDK search call, not REST endpoint
  - splitMessage utility, parallel deletions, ID-based matching
  - Dead code removed: `extractModel` config stripped, `addMemory` documented as public API
  - Privacy notice added
- **Currently adding security features** (sub-agent spawned):
  - `/memory optout` — toggle per-user memory collection
  - Confirmation prompt on forget-all (Discord buttons, 30s timeout)
  - `/memory admin view/clear @user` — mod-only with permission checks
- PR description updated to reflect SDK + graph changes

### Issue #28 — Web Dashboard Shell — BLOCKED (model timeouts)

- Sub-agent scaffolded full Next.js project in `web/` directory
- Versions correct: Next.js 16, React 19, Tailwind v4, Shadcn UI
- Code exists locally on `feat/web-dashboard-shell` branch but UNCOMMITTED
- Sub-agent died twice from model timeouts (Opus + GLM-5 both timed out)
- Needs respawn to commit, push, create PR

## Claude CI Review Upgrade

- Upgraded `.github/workflows/claude-review.yml`:
  - Model: `claude-opus-4-5-20251101`
  - In-depth review prompt covering code quality, architecture, testing, security, Discord-specific, docs, performance
  - Inline comments via `mcp__github_inline_comment__create_inline_comment`
  - Top-level summary via `gh pr comment`
  - **Verdict**: `gh pr review --approve` or `--request-changes`
  - Zero tolerance: ANY finding = request-changes. Only zero-issue PRs get approved.
- Pushed directly to main (CI config change)

## Critical Rules Established Today

- **GitHub Issues = source of truth for bills-bot** — not the Veritas Kanban board
- **Always use latest versions** — Next.js 16, Tailwind v4, React 19, etc. No exceptions.
- **Git worktrees mandatory for sub-agents** — `git worktree add /tmp/bills-bot-<branch>`. Never checkout in main repo. Caused sub-agent death when parallel work conflicted.
- **Codesession tracking enforced** — sub-agents were skipping `cs log-ai` and `cs note`. Rewrote CODING.md with explicit checklist and added reminders to spawn templates.

## Config

- Fallback model for all agents: `zai/glm-5` (free tier, 200K context)
- Heartbeat model: `anthropic/claude-haiku-4-5`

## PR #59 Review Fixes Detail (12 unresolved comments)

Across 4 files, identified and planned fixes:

**src/commands/memory.js:**

1. Use `splitMessage()` utility instead of manual truncation (line 100)
2. Fragile memory matching by exact text equality (line 160) — needs ID-based matching
3. Sequential HTTP deletes → `Promise.allSettled` for parallelization (line 159)

**src/modules/memory.js:** 4. **CRITICAL**: Transient failure permanently disables memory (`mem0Available = false`) with no recovery — fixed with 60s auto-recovery cooldown 5. Health check endpoint → use SDK search call instead of raw REST 6. Privacy concern: `extractAndStoreMemories` sends user messages to external service — added privacy notice 7. `addMemory` exported but unused in production — documented as public API 8. `extractModel` config option defined but never consumed — stripped out

**tests/commands/memory.test.js:** 9. Verify `deferReply` called in forget tests (line 236)

**tests/modules/memory.test.js:** 10. Misleading test name — doesn't actually test the failure path (line 184)

## Dashboard Sub-Agent Status

- Sub-agent `561e6bf8` respawned to finish issue #28
- Branch `feat/web-dashboard-shell` has scaffolded Next.js 16 + React 19 + Tailwind v4 project in `web/`
- All changes are **uncommitted** — sub-agent needs to validate, commit, push, create PR
- Sub-agent kept dying from model timeouts (Opus + GLM-5 both timed out)

## Next Up After Current PRs

- #38 (warning system) — next priority after #59 and #28 merge
- #29 (dashboard REST API) — blocked by #28

## Evening Session (8pm–10pm EST)

### PR #59 — Rounds 2-3 Complete
- Round 2: Fixed all 18 review threads (9 unique issues) — loadOptOuts called on startup, config defaults to disabled on failure, markUnavailable in delete functions, shared truncation helper, test fixes
- Round 3: Fixed 4 more threads — error classification (transient vs permanent), JSDoc for asymmetric behavior, timer leak prevention, explicit health check mock
- **40 total threads, all resolved**

### PR #60 — Web Dashboard Shell (Issue #28) — PR Created + 5 Review Rounds
- Sub-agent recovered stashed work, audited, fixed build issues, created PR #60
- Stack: Next.js 16.1.6, React 19.2.4, TypeScript 5.9.3, Tailwind v4, NextAuth
- Round 1-5 review fixes:
  - Token refresh logic, rate limiting, bot API auth
  - Dockerfile monorepo paths, proxy.ts named export (Next.js 16 convention)
  - Logger utility replacing console.warn/error, localStorage guild persistence
  - **AnExiledDev deep review (17 issues)**: Removed access token from client session, secret validation, security headers, guild pagination, error boundaries, session guard, health endpoint, AbortController cleanup
  - Login callbackUrl passthrough, discord.ts split into server-only + client-safe modules
  - Fixed dangerous `permissions=8` (Administrator) → minimal bot permissions
- **56 total threads across all rounds**

### PR #62 — Mention Gate (Issue #61) — Created + 4 Review Rounds
- Two-layer protection: Client-level `allowedMentions: { parse: ['users'] }` + text sanitization
- Created safeSend/safeReply/safeFollowUp/safeEditReply wrappers
- Migrated ALL 22+ source files to use safe wrappers (zero raw calls remaining)
- Round 3-4 fixes: splitMessage integration (truncate for interactions, split for channels), Winston error logging, memory.js migration (CRITICAL — was exploitable via mem0 content), email regex false positive fix, stale test comments, edge case tests
- **AnExiledDev deep review**: Fixed all 6 issues including memory.js vulnerability
- **12 total threads, all resolved**

### PR #63 — mem0 Deep Review Fixes (New PR)
- Created from AnExiledDev's deep review on PR #59 (14 issues, fixed 9)
- Fixes: falsy ID filter, formatRelations undefined guard, 5s timeout on buildMemoryContext, removed markUnavailable from fire-and-forget, 10s health check timeout, renamed isMemoryAvailable → split into pure getter + checkAndRecoverMemory, looping batch delete, 2000-char context budget, username in metadata
- Final fix: `|| ''` → `?? ''` for falsy ID coercion
- **1 thread, resolved**

### Issue #61 Created — Hard gate to prevent @here/@everyone mentions
- Filed under Moderation (#37)
- discord.js `allowedMentions` is legit — server-side enforcement via Discord API

### Codesession Parallel Session Discovery
- `codesession` does NOT support parallel sessions — `cs start` fails if any session is active
- `--close-stale` kills other sub-agents' sessions
- **Fix**: Each command supports `--session <id>` flag for targeting specific sessions
- BUT `cs start` itself can't create parallel sessions — fundamental limitation
- Updated CODING.md, MEMORY.md, HEARTBEAT.md, AGENTS.md to use `--session <id>` everywhere and ban `--close-stale`
- Bill will ask codesession developer to add parallel session support

### Claude CI Review Update
- Removed praise/positives from review output — issues only, no "what's good"
- Pushed to main

### Key Rule Added
- **PR comments are PAGINATED** — always use `--paginate` when fetching. GitHub returns max 30 per page.

## Files Modified
- `MEMORY.md` — updated project info, spawn templates (worktree + codesession), critical rules, feature pipeline, pagination rule
- `CODING.md` — added git worktree rule, rewrote codesession section with `--session <id>`, verbose notes
- `HEARTBEAT.md` — added `--session <id>` to PR patrol spawn instructions
- `AGENTS.md` — added `--session <id>` to codesession note
- `.github/workflows/claude-review.yml` (bills-bot) — full rewrite + removed praise
