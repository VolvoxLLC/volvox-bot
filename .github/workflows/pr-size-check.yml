name: PR Size Check

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  pr-size:
    name: PR Size Warning
    runs-on: ubuntu-latest
    steps:
      - name: Warn for oversized pull requests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          ADDITIONS: ${{ github.event.pull_request.additions }}
          DELETIONS: ${{ github.event.pull_request.deletions }}
          CHANGED_FILES: ${{ github.event.pull_request.changed_files }}
          THRESHOLD: '1000'
        run: |
          node <<'NODE'
          (async () => {
            const fs = require('node:fs');
            const marker = '<!-- pr-size-check -->';
            const additions = Number(process.env.ADDITIONS || 0);
            const deletions = Number(process.env.DELETIONS || 0);
            const changedFiles = Number(process.env.CHANGED_FILES || 0);
            const threshold = Number(process.env.THRESHOLD || 1000);
            const total = additions + deletions;
            const oversized = total > threshold;

            const summary = `PR changes: +${additions} / -${deletions} (${total} lines across ${changedFiles} files)`;
            console.log(summary);
            fs.appendFileSync(
              process.env.GITHUB_STEP_SUMMARY,
              `## PR Size Check\n\n${summary}\n\nThreshold: ${threshold} changed lines.\n`,
            );

            if (!oversized) {
              console.log('PR size is within threshold.');
              return;
            }

            console.log(`::warning title=Large Pull Request::This PR changes ${total} lines, which exceeds the ${threshold}-line threshold.`);

            const [owner, repo] = process.env.REPO.split('/');
            const prNumber = process.env.PR_NUMBER;
            const headers = {
              Authorization: `Bearer ${process.env.GITHUB_TOKEN}`,
              Accept: 'application/vnd.github+json',
              'X-GitHub-Api-Version': '2022-11-28',
            };

            const body = [
              marker,
              '⚠️ **Large PR warning**',
              '',
              `This PR is **${total} changed lines** (+${additions}/-${deletions}) across **${changedFiles} files**, which is above the **${threshold}-line** threshold.`,
              '',
              'Consider splitting this into smaller PRs for faster, safer review.',
              '',
              `PR: ${process.env.PR_URL}`,
            ].join('\n');

            const commentsRes = await fetch(
              `https://api.github.com/repos/${owner}/${repo}/issues/${prNumber}/comments?per_page=100`,
              { headers },
            );

            if (!commentsRes.ok) {
              throw new Error(`Failed to list comments: ${commentsRes.status}`);
            }

            const comments = await commentsRes.json();
            const existing = comments.find(
              (comment) => comment.user?.login === 'github-actions[bot]' && comment.body?.includes(marker),
            );

            if (existing) {
              const patchRes = await fetch(
                `https://api.github.com/repos/${owner}/${repo}/issues/comments/${existing.id}`,
                {
                  method: 'PATCH',
                  headers,
                  body: JSON.stringify({ body }),
                },
              );
              if (!patchRes.ok) {
                throw new Error(`Failed to update warning comment: ${patchRes.status}`);
              }
              console.log(`Updated existing warning comment (${existing.id}).`);
            } else {
              const postRes = await fetch(
                `https://api.github.com/repos/${owner}/${repo}/issues/${prNumber}/comments`,
                {
                  method: 'POST',
                  headers,
                  body: JSON.stringify({ body }),
                },
              );
              if (!postRes.ok) {
                throw new Error(`Failed to create warning comment: ${postRes.status}`);
              }
              console.log('Created warning comment.');
            }
          })().catch((error) => {
            console.error(error);
            process.exit(1);
          });
          NODE
