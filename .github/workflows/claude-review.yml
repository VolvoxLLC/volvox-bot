name: Claude Code Review

on:
  pull_request:
    types: [opened, reopened, synchronize]
  issue_comment:
    types: [created]

jobs:
  claude-review:
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1

      - name: Claude Code Review
        uses: anthropics/claude-code-action@23ed4cb53d6eacddbc22ec16652c98bcc54e0476 # v1.0.48
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          timeout_minutes: 15
          track_progress: true
          use_sticky_comment: true
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            You are reviewing a Discord bot built with Node.js ESM, discord.js v14, Biome, and Vitest.
            Read AGENTS.md for full project conventions before reviewing.

            Perform a thorough, in-depth review covering ALL of the following:

            ## Code Quality
            - ESM conventions (import/export, node: protocol, no require())
            - Biome compliance (single quotes, semicolons, 2-space indent, no console.*)
            - Winston logger usage â€” NEVER console.log/warn/error in src/ files
            - DRY principle, meaningful names, no commented-out code
            - JSDoc on all exported functions/classes
            - Error handling patterns (custom error classes from src/utils/errors.js)

            ## Architecture & Patterns
            - Follows existing project patterns (config module, event registration, command structure)
            - Proper separation of concerns (commands vs modules vs utils)
            - Config accessed via getConfig(), mutations via setConfigValue()
            - New modules registered in src/modules/events.js

            ## Testing
            - Tests exist for all new code
            - Edge cases covered
            - Coverage stays above 80% (statements, branches, functions, lines)
            - Vitest patterns used correctly

            ## Security
            - No hardcoded credentials or tokens
            - Input validation on user-facing commands
            - Permission checks (hierarchy, role checks) for moderation commands
            - No sensitive data in logs
            - SQL injection prevention (parameterized queries only)

            ## Discord-Specific
            - 2000-char message limit handled (splitMessage utility)
            - Proper intent declarations if new events are used
            - DM before action pattern for moderation (DM target before kick/ban)
            - Ephemeral replies for moderation commands
            - Duration caps (timeout 28d, slowmode 6h)

            ## Documentation
            - README.md updated if needed
            - AGENTS.md updated if new files/patterns added
            - .env.example updated if new env vars
            - config.json documented for new config sections

            ## Performance
            - No unnecessary awaits or blocking operations
            - Efficient database queries
            - Proper cleanup (intervals cleared, connections closed)
            - Memory leak potential (unbounded caches, event listener leaks)

            INSTRUCTIONS:
            - Use inline comments (mcp__github_inline_comment__create_inline_comment) for specific code issues with file path and line numbers
            - Use `gh pr comment` for a top-level summary of findings
            - Be specific and actionable â€” suggest fixes, not just problems
            - Categorize findings by severity: ðŸ”´ Critical, ðŸŸ¡ Warning, ðŸ”µ Nitpick
            - **ONLY report issues** â€” do NOT include praise, "what's good", positives, or compliments. No "great job", no "well done", no "nice pattern". The review output should contain ONLY things that need fixing. If there are zero issues, just approve with a one-line message.
            - Do NOT invent issues â€” only flag real problems

            VERDICT (MANDATORY â€” do this LAST):
            After reviewing, submit a GitHub review verdict:
            - If there are ANY issues (ðŸ”´ Critical, ðŸŸ¡ Warning, or ðŸ”µ Nitpick): use inline comments for each issue AND `gh pr review ${{ github.event.pull_request.number }} --request-changes -b "Summary of all issues that must be fixed"`
            - If the PR is completely clean with zero issues: `gh pr review ${{ github.event.pull_request.number }} --approve -b "LGTM"` â€” do NOT post any top-level PR comment, do NOT post inline comments. Just approve silently.
            You MUST submit exactly one review verdict. Never skip this step. Only approve if there are ZERO findings.
            IMPORTANT: When approving, do NOT use `gh pr comment` at all. No summary comment, no praise, nothing. Just the approve verdict.

          claude_args: '--model claude-opus-4-5-20251101 --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr review:*),Read,Bash(cat:*),Bash(grep:*),Bash(find:*)"'
